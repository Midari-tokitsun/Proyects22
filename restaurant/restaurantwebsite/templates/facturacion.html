<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="//cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="//cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>

<!-- DataTables CSS library -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.css"/>
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/dataTables.bootstrap4.min.css"/>

<link rel="stylesheet" href="//stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">


<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>

<script src="//code.jquery.com/jquery-3.5.1.js"></script>
<!-- DataTables JS library -->
<script type="text/javascript" src="//cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
<!-- DataTables JBootstrap -->
<script type="text/javascript" src="//cdn.datatables.net/1.11.3/js/dataTables.bootstrap4.min.js"></script>

    
    
    <title>Facturacion</title>
</head>
<body>
    


    <table id="mitabla" class="container" cellspacing="0" width="100%">
        <thead>
        <tr>
        <th>ID</th>
        <th>Codigo CAI</th>
        <th>Numero de Factura</th>
        <th>Nombre del Encargado</th>
        <th>Apellido del Encargado</th>
        <th>Correo del Encargado</th>
        <th>Numero Telefonico</th>
        <th>Nombre del Cliente</th>
        <th>Nombre del Menu y Cantidades</th>
        <th>Tamaño del Menu</th>
        <th>Estado del Pedido</th>
        <th>Fecha de Realizacion del Pedido</th>
        <th>Descuentos</th>
        <th>ISV</th>
        <th>Metodo de Pago</th>
        <th>Numero de la Tarjeta</th>
        <th>Cantidad a Pagar</th>
        <th>Total a Pagar</th>
        <th>Cambio</th>
        <th>Acciones</th>
      </tr>
        </thead>
        <tfoot>
            <tr>
              <th>ID</th>
              <th>Codigo CAI</th>
              <th>Numero de Factura</th>
              <th>Nombre del Encargado</th>
              <th>Apellido del Encargado</th>
              <th>Correo del Encargado</th>
              <th>Numero Telefonico</th>
              <th>Nombre del Cliente</th>
              <th>Nombre del Menu y Cantidades</th>
              <th>Tamaño del Menu</th>
              <th>Estado del Pedido</th>
              <th>Fecha de Realizacion del Pedido</th>
              <th>Descuentos</th>
              <th>ISV</th>
              <th>Metodo de Pago</th>
              <th>Numero de la Tarjeta</th>
              <th>Cantidad a Pagar</th>
              <th>Total a Pagar</th>
              <th>Cambio</th>
              <th>Acciones</th>
                      </tr>
        </tfoot>
        
        <tbody>
            {% for f in fact %}
        <tr>
        <td>{{f.id_factura}}</td>
        <td>{{f.codigo_cai}}</td>
        <td>{{f.numero_factura}}</td>
        <td>{{f.nombre_encargado}}</td>
        <td>{{f.apellido_encargado}}</td>
        <td>{{f.correo_encargado}}</td>
        <td>{{f.telefono_encargado}}</td>
        <td>{{f.nombre_cliente}}</td>
        <td>{{f.menu_cantidades}}</td>
        <td>{{f.tamaño_menu}}</td>
        <td>{{f.estado_pedido}}</td>
        <td>{{f.fecha_realizacion_pedido}}</td>
        <td>{{f.descuento}}</td>
        <td>{{f.isv}}</td>
        <td>{{f.metodo_pago}}</td>
        <td>{{f.numero_tarjeta}}</td>
        <td>{{f.cantidad_pagar}}</td>
        <td>{{f.total_pagar}}</td>
        <td>{{f.cambio}}</td>
        <td><!-- Button trigger modal -->
			<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editarmodalpedido-{{forloop.counter}}">
				EDITAR
			  </button>
            <a href="/factura_pdf/{{f.id_factura}}" class="btn btn-primary">Ver Factura PDF</a>
        </td>
        
        
    </tr>

        {% endfor %}
        </tbody>
        </table>



        <style>
   body{
      background: url("{% static 'images/pizzab14.jpg' %}") center no-repeat;
    background-size: cover;

    }

            /* Estilos para la grilla */
            .grid-container {
              display: grid;
              grid-template-columns: repeat(3, 1fr);
              grid-gap: 5px;
            }
            .grid-item {
              background-color: #ddd;
              padding: 15px;
              font-size: 15px;
              text-align: center;
            }
          </style>
      
<!-- Button trigger modal -->
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#agregarfacturamodal">
    Agregar Factura
 </button>
   
 <!-- Modal -->
 <div class="modal fade" id="agregarfacturamodal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
   <div class="modal-dialog modal-lg">
     <div class="modal-content">
       <div class="modal-header">
         <h1 class="modal-title fs-5" id="exampleModalLabel">Nueva Factura</h1>
         <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
       </div>

       <div class="modal-body">
      
        <form id="factura-form" action="{% url 'agregarfactura' %}" method="POST">
          {% csrf_token %}
          <label for="">ID Factura</label>
          <input  type="text" class="form-control" name="id_factura" id="id_factura">
      

          <br>
          <div class="mb-3">
            <label for="cliente" class="form-label">Codigo CAI</label>
            <select class="form-control" name="codigo_cai" id="codigo_cai">
               <option value="" selected>Selecciona un CAI</option>
               {% for s in sar %}
               <option value="{{s.codigo_sar}}">{{s.codigo_sar}}</option>
               {% endfor %}             
           </select>
          </div>
    
          <br>
           <label for="">Numero de Factura</label>
            <input type="text" class="form-control" name="numero_factura" id="numero_factura">

            <br>
        {% if request.session %}

         <label for="">Nombre del Encargado</label>
         <input name="nombre_encargado" class="form-control" value="{{ request.session.nombre }}" readonly>
         <label for="">Apellido del Encargado</label>
         <input name="apellido_encargado" class="form-control" value="{{ request.session.apellido }}" readonly>
         <label for="">Correo Electronico</label>
         <input name="correo_encargado" class="form-control" value="{{ request.session.email }}" readonly>
         <label for="">Telefono</label>
         <input name="telefono_encargado" class="form-control" value="{{ request.session.telefono }}" readonly>

         {% endif %}
           <!-- Aquí agregas los campos necesarios para la factura, como el nombre del cliente, fecha, etc. -->
           <h1>Descripcion de la Factura</h1>
            <br>
           <div class="mb-3">
             <label for="cliente" class="form-label">Nombre del Cliente</label>
             <select class="form-control" name="nombre_cliente" id="cliente-select">
                <option value="" selected>Consumidor Final</option>
                {% for u in user %}
                <option value="{{u.nombre}}">{{u.nombre}}</option>
                {% endfor %}             
            </select>
           </div>
            <br>

            <div class="mb-3">
              <label for="menu" class="form-label">Nombre del Menú</label>
              <textarea class="form-control" type="text" name="menu_cantidades" id="menu-input" readonly></textarea>
          </div>
          

          
          <div class="mb-3">
              <label for="detalle" class="form-label">Tamaño del Menú</label>
              <input class="form-control" type="text" name="tamaño_menu" id="detalle-input" readonly>
          </div>
          
          <div class="mb-3">
              <label for="estado_pedido" class="form-label">Estado del Pedido</label>
              <input class="form-control" type="text" name="estado_pedido" id="estado-input" readonly>
          </div>
          
          <div class="mb-3">
              <label for="fecha_realizacion_pedido" class="form-label">Fecha de Realización del Pedido</label>
              <input class="form-control" type="text" name="fecha_realizacion_pedido" id="fecha-input" readonly>
          </div>
            

          <div class="mb-3">
            <label for="descuento" class="form-label">Descuento</label>
            <select class="form-control" name="descuento" id="descuento">
              <option value="0" selected>0%</option>
              <option value="0.05">5%</option>
              <option value="0.10">10%</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="isv" class="form-label">ISV</label>
            <select class="form-control" name="isv" id="isv">
              <option value="0.15" selected>15%</option>
              <option value="0.18">18%</option>
            </select>
          </div>
   

              <div class="mb-3">
                <label for="metodo-pago" class="form-label">Método de Pago</label>
                <select class="form-control" name="metodo_pago" id="metodo-pago">
                    <option value="" selected disabled>Selecciona un Metodo de Pago</option>
                    {% for m in meto %}
                        {% if m.forma_pago != "Mixto" %}
                            <option value="{{m.forma_pago}}" >{{m.forma_pago}}</option>
                        {% else %}
                            <option value="{{m.forma_pago}}" >{{m.forma_pago}}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3" id="input-tarjeta" hidden>
                <label for="tarjeta" class="form-label">Tarjeta</label>
                <input type="text" class="form-control" id="tarjeta" name="numero_tarjeta">
            </div>
            <div class="mb-3" id="input-efectivo" hidden>
                <label for="efectivo" class="form-label">Efectivo</label>
                <input type="text" class="form-control" id="efectivo" name="efectivo">
            </div>
            <div class="mb-3" id="input-mixto" hidden>
                <label for="tarjeta" class="form-label">Tarjeta</label>
                <input type="text" class="form-control" id="tarjeta-mixto" name="tarjeta-mixto">
                <br>
                <label for="efectivo" class="form-label">Efectivo</label>
                <input type="text" class="form-control" id="efectivo-mixto" name="efectivo-mixto">
            </div>


            <label for="cantidad-a-pagar">Cantidad a pagar:</label>
            <input id="cantidad-a-pagar" class="form-control" type="text" name="cantidad_pagar">
<!-- Este es el contenedor de la grilla de selección de menú -->
<div id="menu-grid-container">
  <h2>Seleccione un menú:</h2>
  <div class="grid-container">
    {% for m in men %}
    <div class="grid-item" data-menu="{{m.nombre_menu}}" data-precio="{{m.precio_menu}}">{{m.nombre_menu}} - {{m.precio_menu}}</div>
    {% endfor %}
  </div>
</div>


<div id="selected-menus-container">
  <h2>Menús seleccionados:</h2>
  <ul id="selected-menus-list"></ul>
</div>

           <br>
           <label class="form-label" for="total-a-pagar">Total a pagar:</label>
           <input name="total_pagar" id="total-a-pagar" class="form-control" type="text" >
           <button class="btn btn-danger" id="reset-total-button" type="button">Resetear cuenta</button>
           <br>

           <br>
           <label for="cambio">Cambio (Vuelto):</label>
           <input id="cambio" class="form-control" type="text" name="cambio">
      <br>
     
           <div class="modal-footer">

            <button type="submit" class="btn btn-primary">GUARDAR</button>
           </div>
           
         </form>
       </div>


        <script>




$(document).ready(function() {
        // Escuchar cambios en la selección del cliente
        $('#cliente-select').change(function() {
            var cliente_id = $(this).val();
            
            // Hacer una llamada AJAX para obtener los detalles del pedido
            $.ajax({
                url: '/obtener_detalles_pedido/',
                data: {
                    cliente_id: cliente_id
                },
                success: function(data) {
                    // Actualizar los campos de entrada correspondientes con los detalles del pedido
                    $('#menu-input').val(data.menu_nombre);
                    $('#cantidades-input').val(data.cantidades);
                    $('#detalle-input').val(data.tamaño_menu);
                    $('#estado-input').val(data.estado_pedido);
                    $('#fecha-input').val(data.fecha);
                },
                error: function(xhr, status, error) {
                    console.error(error);
                }
            });
        });
    });

const select = document.getElementById('metodo-pago');
    const inputTarjeta = document.getElementById('input-tarjeta');
    const inputEfectivo = document.getElementById('input-efectivo');
    const inputMixto = document.getElementById('input-mixto');
    select.addEventListener('change', (event) => {
        if (event.target.value === 'tarjeta') {
            inputTarjeta.hidden = false;
            inputEfectivo.hidden = true;
            inputMixto.hidden = true;
        } else if (event.target.value === 'efectivo') {
            inputEfectivo.hidden = false;
            inputTarjeta.hidden = true;
            inputMixto.hidden = true;
        } else if (event.target.value === 'mixto') {
            inputMixto.hidden = false;
            inputEfectivo.hidden = true;
            inputTarjeta.hidden = true;
        } else {
            inputEfectivo.hidden = true;
            inputTarjeta.hidden = true;
            inputMixto.hidden = true;
        }
    });

    

// Obtener elementos del DOM
const gridItems = document.querySelectorAll('.grid-item');
const selectedMenusList = document.getElementById('selected-menus-list');
const totalAPagarInput = document.getElementById('total-a-pagar');
const cantidadAPagarInput = document.getElementById('cantidad-a-pagar');
const cambioInput = document.getElementById('cambio');
const resetTotalButton = document.getElementById('reset-total-button');

// Variables globales
let selectedMenus = []; // Lista de menús seleccionados
let totalAPagar = 0; // Total a pagar

// Agregar evento de escucha a los elementos de la grilla
gridItems.forEach(item => {
  item.addEventListener('click', e => {
    const nombreMenu = e.currentTarget.dataset.menu;
    const precioMenu = Number(e.currentTarget.dataset.precio);
    const menuSeleccionado = { nombre: nombreMenu, precio: precioMenu };
    selectedMenus.push(menuSeleccionado);
    actualizarListaMenusSeleccionados();
    actualizarTotalAPagar();
  });
});

// Actualizar la lista de menús seleccionados
function actualizarListaMenusSeleccionados() {
  selectedMenusList.innerHTML = '';
  selectedMenus.forEach(menu => {
    const li = document.createElement('li');
    li.innerText = `${menu.nombre} - LPS. ${menu.precio.toFixed(2)}`;
    selectedMenusList.appendChild(li);
  });
}
  


function actualizarTotalAPagar() {
  // Obtener el valor del descuento
  const descuento = Number(document.getElementById('descuento').value);

  // Si no se ha seleccionado ningún descuento, establecer el valor en 0
  if (isNaN(descuento)) {
    descuento = 0;
  }

  // Obtener el valor del ISV
  let isv = Number(document.getElementById('isv').value);

  // Si no se ha seleccionado ningún ISV, establecer el valor predeterminado en 0.15
  if (isNaN(isv)) {
    isv = 0.15;
  }

  // Calcular el precio total sin descuento ni ISV
  const precioTotalSinDescuentoNIsv = selectedMenus.reduce((total, menu) => total + menu.precio, 0);

  // Calcular el precio con descuento
  const precioConDescuento = precioTotalSinDescuentoNIsv * (1 - descuento / 100);

  // Calcular el monto del ISV
  const montoIsv = precioConDescuento * isv;

  // Calcular el precio total a pagar
  const precioTotalAPagar = precioConDescuento + montoIsv;

  // Mostrar el precio total a pagar en el input correspondiente
  totalAPagarInput.value = precioTotalAPagar.toFixed(2);

  // Actualizar el cambio
  actualizarCambio();
}


function actualizarCambio() {
  const cantidadAPagar = Number(cantidadAPagarInput.value);
  const totalAPagar = Number(totalAPagarInput.value);
  const cambio = cantidadAPagar - totalAPagar;
  cambioInput.value = cambio.toFixed(2);
}




// Agregar evento de escucha al botón de resetear la cuenta
resetTotalButton.addEventListener('click', () => {
  selectedMenus = [];
  actualizarListaMenusSeleccionados();
  actualizarTotalAPagar();
  cantidadAPagarInput.value = '';
  cambioInput.value = '';
});




            $(document).ready(function() {
            $('#mitabla').DataTable({
            "language": {
            "url": "//cdn.datatables.net/plug-ins/1.10.15/i18n/Spanish.json"
            }
            });
            })
                    </script>

</body>
</html>